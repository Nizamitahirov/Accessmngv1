<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bravo PAM | Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --bravo-green: #2E7D32; 
      --bravo-acc: #4CAF50;
      --bg-body: #F3F4F6;
      --bg-panel: #FFFFFF;
      --text: #111827;
      --border: #E5E7EB;
      --sidebar-w: 260px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

    /* LOGIN */
    #login-overlay { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-card { width: 400px; padding: 40px; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: white; }
    .btn-login { width: 100%; background: var(--bravo-green); color: white; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }

    /* LAYOUT */
    .sidebar { width: var(--sidebar-w); background: #111827; color: white; display: flex; flex-direction: column; }
    .sb-head { height: 64px; display: flex; align-items: center; padding: 0 24px; font-size: 18px; font-weight: 700; color: var(--bravo-acc); border-bottom: 1px solid #1F2937; }
    .sb-menu { padding: 20px 10px; flex: 1; }
    .nav-item { padding: 12px 16px; color: #9CA3AF; cursor: pointer; margin-bottom: 4px; border-radius: 8px; font-size: 14px; font-weight: 500; display: flex; gap: 12px; align-items: center; }
    .nav-item:hover { background: #1F2937; color: white; }
    .nav-item.active { background: var(--bravo-green); color: white; }
    
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .topbar { height: 64px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 32px; flex-shrink: 0; }
    .content { flex: 1; padding: 24px; overflow: hidden; display: flex; flex-direction: column; }
    
    .view-section { display: none; height: 100%; overflow: hidden; }
    .view-section.active { display: flex; flex-direction: column; }

    /* DASHBOARD */
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .stat-val { font-size: 24px; font-weight: 700; margin-top: 5px; }
    .chart-row { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: 300px; margin-bottom: 24px; }
    .chart-box { background: white; padding: 20px; border: 1px solid var(--border); border-radius: 8px; position: relative; }

    /* FILTER PANEL */
    .filter-bar { background: white; padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; flex-shrink: 0; }
    .f-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; min-width: 150px; }
    .view-toggles { display: flex; background: #F3F4F6; padding: 4px; border-radius: 6px; margin-left: auto; }
    .vt-btn { padding: 6px 12px; border: none; background: none; cursor: pointer; font-size: 12px; border-radius: 4px; font-weight: 600; color: #666; }
    .vt-btn.active { background: white; color: black; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    /* TABLES & MATRIX - SCROLL CONTAINER */
    .data-box { 
      background: white; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      overflow: hidden;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    
    .tbl-wrap { 
      overflow: auto !important;
      flex: 1;
      position: relative;
    }
    
    /* Custom scrollbars */
    .tbl-wrap::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    
    .tbl-wrap::-webkit-scrollbar-track {
      background: #F9FAFB;
    }
    
    .tbl-wrap::-webkit-scrollbar-thumb {
      background: var(--bravo-acc);
      border-radius: 6px;
      border: 2px solid #F9FAFB;
    }
    
    .tbl-wrap::-webkit-scrollbar-thumb:hover {
      background: var(--bravo-green);
    }
    
    .tbl-wrap::-webkit-scrollbar-corner {
      background: #F9FAFB;
    }
    
    table { 
      width: max-content;
      min-width: 100%;
      border-collapse: collapse; 
      font-size: 13px; 
    }
    
    th { 
      text-align: left; 
      padding: 10px 12px; 
      background: #F9FAFB; 
      border-bottom: 1px solid var(--border); 
      color: #666; 
      font-size: 11px; 
      text-transform: uppercase; 
      white-space: nowrap; 
      width: 1px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    td { 
      padding: 10px 12px; 
      border-bottom: 1px solid var(--border); 
      white-space: nowrap; 
      width: 1px;
    }
    
    /* Matrix Specific */
    .matrix-col-sticky { 
      position: -webkit-sticky;
      position: sticky; 
      left: 0; 
      z-index: 20; 
      background: white !important; 
      border-right: 2px solid #E5E7EB;
      box-shadow: 2px 0 5px rgba(0,0,0,0.05);
    }
    
    thead .matrix-col-sticky {
      z-index: 30 !important;
      background: #F9FAFB !important;
    }
    
    /* VERTİKAL SİSTEM BAŞLIQLARI - AŞAĞIDAN YUXARI */
    .sys-header { 
      writing-mode: vertical-lr;
      text-orientation: mixed; 
      white-space: nowrap; 
      padding: 12px 6px !important;
      width: 1px !important;
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      background: #F9FAFB;
      color: #374151;
      transform: rotate(180deg);
    }
    
    .cell-val { 
      font-family: 'JetBrains Mono'; 
      font-weight: 700; 
      padding: 4px 6px; 
      border-radius: 4px; 
      display: inline-block;
      min-width: auto;
      text-align: center;
      font-size: 11px;
      transition: all 0.2s ease;
      line-height: 1.2;
    }
    .cv-M { background: #DCFCE7; color: #166534; border: 1px solid #86EFAC; }
    .cv-S { background: #FEF3C7; color: #92400E; border: 1px solid #FDE047; }
    
    /* HOVER EFFEKTLƏRİ */
    .editable { 
      position: relative;
      transition: all 0.15s ease;
      cursor: pointer;
    }
    
    .editable:hover { 
      background: linear-gradient(135deg, #F0FDF4 0%, #E6F7ED 100%) !important;
      box-shadow: inset 0 0 0 2px var(--bravo-acc);
    }
    
    .editable:hover .cell-val {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(46, 125, 50, 0.2);
    }
    
    .editable:hover::after {
      content: '✏️ Click: M / S / Revoke';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
      margin-bottom: 4px;
    }
    
    .matrix-cell-empty {
      background: #FAFAFA;
      color: #D1D5DB;
      font-size: 14px;
    }

    /* PAGINATION */
    .pagination-bar {
      padding: 12px 20px;
      background: #F9FAFB;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .pagination-info {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }
    
    .pagination-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .page-select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      background: white;
      cursor: pointer;
      font-weight: 600;
    }
    
    .page-btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .page-btn:hover:not(:disabled) {
      background: var(--bravo-green);
      color: white;
      border-color: var(--bravo-green);
    }
    
    .page-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* APPROVALS */
    .action-bar { padding: 12px 20px; background: #F9FAFB; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; }
    
    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal { 
      background: white; 
      width: 500px; 
      border-radius: 12px; 
      padding: 24px; 
      box-shadow: 0 20px 25px rgba(0,0,0,0.1); 
      position: relative;
      animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .modal-close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: #F3F4F6;
      color: #6B7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 16px;
    }
    
    .modal-close-btn:hover {
      background: #E5E7EB;
      color: #374151;
      transform: rotate(90deg);
    }
    
    .btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; border: none; font-size: 13px; transition: 0.2s; }
    .btn-green { background: var(--bravo-green); color: white; }
    .btn-green:hover { background: #1B5E20; transform: translateY(-1px); }
    .btn-red { background: #EF4444; color: white; }
    .btn-red:hover { background: #DC2626; }
    .btn-white { background: white; border: 1px solid var(--border); }
    .btn-white:hover { background: #F9FAFB; }
    
    .loader { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 3000; background: rgba(76,175,80,0.2); display: none; }
    .bar { width: 0%; height: 100%; background: var(--bravo-acc); animation: load 1.5s infinite; }
    @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }
  </style>
</head>
<body>

  <div class="loader" id="loader"><div class="bar"></div></div>

  <!-- LOGIN -->
  <div id="login-overlay">
    <div class="login-card">
      <div style="font-size:24px; font-weight:800; color:var(--bravo-green); margin-bottom:20px;">
        <i class="fa-solid fa-shield-halved"></i> BRAVO PAM
      </div>
      <label style="font-size:12px; font-weight:600; color:#666">Username</label>
      <input id="u-in" class="f-input" style="width:100%; margin-bottom:15px; padding:12px;">
      <label style="font-size:12px; font-weight:600; color:#666">Password</label>
      <input id="p-in" type="password" class="f-input" style="width:100%; margin-bottom:20px; padding:12px;">
      <button class="btn-login" onclick="login()">Secure Login</button>
      <div id="l-msg" style="color:red; font-size:12px; margin-top:10px; text-align:center"></div>
    </div>
  </div>

  <!-- APP STRUCTURE -->
  <div class="sidebar" id="app-sb" style="display:none">
    <div class="sb-head"><i class="fa-solid fa-shield-halved" style="margin-right:10px"></i> BRAVO</div>
    <div class="sb-menu">
      <div class="nav-item active" onclick="nav('dash')"><i class="fa-solid fa-chart-pie"></i> Dashboard</div>
      <div class="nav-item" onclick="nav('matrix')"><i class="fa-solid fa-table-cells"></i> Access Matrix</div>
      <div class="nav-item" onclick="nav('approvals')">
        <i class="fa-solid fa-check-double"></i> Approvals
        <span class="badge" style="background:#F59E0B; color:white; margin-left:auto; display:none" id="badge-cnt">0</span>
      </div>
    </div>
    <div style="padding:20px; border-top:1px solid #1F2937">
      <div style="font-size:13px; font-weight:600" id="sb-user">-</div>
      <div style="font-size:11px; color:#9CA3AF" id="sb-role">-</div>
    </div>
  </div>

  <div class="main" id="app-main" style="display:none">
    <div class="topbar">
      <div style="font-weight:600; font-size:18px" id="pg-title">Dashboard</div>
      <button class="btn btn-white" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>

    <div class="content">
      
      <!-- DASHBOARD -->
      <div id="v-dash" class="view-section active">
        <div class="stats-row">
          <div class="stat-card">
            <div style="font-size:12px; color:#666">Total Records</div>
            <div class="stat-val" id="st-total">0</div>
          </div>
          <div class="stat-card">
            <div style="font-size:12px; color:#666">Active Access</div>
            <div class="stat-val" style="color:var(--bravo-green)" id="st-active">0</div>
          </div>
          <div class="stat-card">
            <div style="font-size:12px; color:#666">Pending Approval</div>
            <div class="stat-val" style="color:#F59E0B" id="st-pending">0</div>
          </div>
          <div class="stat-card">
            <div style="font-size:12px; color:#666">Rejected</div>
            <div class="stat-val" style="color:#EF4444" id="st-reject">0</div>
          </div>
        </div>

        <div class="chart-row">
          <div class="chart-box">
            <canvas id="chart-status"></canvas>
          </div>
          <div class="chart-box">
             <canvas id="chart-sys"></canvas>
          </div>
        </div>
      </div>

      <!-- MATRIX -->
      <div id="v-matrix" class="view-section">
        <div class="filter-bar">
          <i class="fa-solid fa-filter" style="color:#666"></i>
          <input id="f-dept" class="f-input" placeholder="Filter Dept..." onkeyup="filterMat()">
          <input id="f-role" class="f-input" placeholder="Filter Role..." onkeyup="filterMat()">
          <input id="f-sys" class="f-input" placeholder="Filter System..." onkeyup="filterMat()">
          <div class="view-toggles">
            <button class="vt-btn active" onclick="setMatView('grid')"><i class="fa-solid fa-table"></i></button>
            <button class="vt-btn" onclick="setMatView('list')"><i class="fa-solid fa-list"></i></button>
          </div>
        </div>

        <div class="data-box">
          <div class="tbl-wrap" id="mat-container"></div>
          <div class="pagination-bar">
            <div class="pagination-info" id="mat-page-info">Showing 1-20 of 100</div>
            <div class="pagination-controls">
              <span style="font-size: 12px; color: #666; margin-right: 8px;">Rows:</span>
              <select class="page-select" id="mat-page-size" onchange="changeMatPageSize()">
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
              </select>
              <button class="page-btn" id="mat-prev" onclick="matPrevPage()">
                <i class="fa-solid fa-chevron-left"></i> Prev
              </button>
              <button class="page-btn" id="mat-next" onclick="matNextPage()">
                Next <i class="fa-solid fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- APPROVALS -->
      <div id="v-approvals" class="view-section">
        <div class="data-box">
          <div class="action-bar">
            <div style="font-weight:600">Pending My Action</div>
            <button class="btn btn-green" id="btn-bulk" onclick="openBulk()" disabled>Take Action (0)</button>
          </div>
          <div class="tbl-wrap">
            <table id="app-tbl">
              <thead><tr><th style="width:30px"><input type="checkbox" onchange="toggleAll(this)"></th><th>ID</th><th>Dept</th><th>Role</th><th>System</th><th>Access</th><th>Status</th></tr></thead>
              <tbody id="app-body"></tbody>
            </table>
          </div>
          <div class="pagination-bar">
            <div class="pagination-info" id="app-page-info">No items</div>
            <div class="pagination-controls">
              <span style="font-size: 12px; color: #666; margin-right: 8px;">Rows:</span>
              <select class="page-select" id="app-page-size" onchange="changeAppPageSize()">
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <button class="page-btn" id="app-prev" onclick="appPrevPage()">
                <i class="fa-solid fa-chevron-left"></i> Prev
              </button>
              <button class="page-btn" id="app-next" onclick="appNextPage()">
                Next <i class="fa-solid fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- BULK MODAL -->
  <div class="modal-overlay" id="m-bulk" onclick="if(event.target === this) closeM('m-bulk')">
    <div class="modal" onclick="event.stopPropagation()">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Process Request</h3>
        <button class="modal-close-btn" onclick="closeM('m-bulk')" title="Close">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <p style="font-size:13px; color:#666; margin-bottom:20px">Please select an action for the selected requests.</p>
      
      <label style="font-size:12px; font-weight:600">Comment (Required for Rejection)</label>
      <textarea id="bulk-comment" class="f-input" style="width:100%; height:80px; margin-bottom:20px;"></textarea>
      
      <div style="display:flex; gap:10px; justify-content:flex-end">
        <button class="btn btn-white" onclick="closeM('m-bulk')">Cancel</button>
        <button class="btn btn-red" onclick="submitBulk('Rejected')">Reject</button>
        <button class="btn btn-green" onclick="submitBulk('Approved')">Approve</button>
      </div>
    </div>
  </div>

  <!-- CELL EDIT MODAL -->
  <div class="modal-overlay" id="m-edit" onclick="if(event.target === this) closeM('m-edit')">
    <div class="modal" onclick="event.stopPropagation()">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Modify Access</h3>
        <button class="modal-close-btn" onclick="closeM('m-edit')" title="Close (ESC)">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div id="e-info" style="font-size:13px; color:#666; margin-bottom:20px; font-weight:600; padding: 10px; background: #F9FAFB; border-radius: 6px; border-left: 3px solid var(--bravo-green);"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px">
        <button class="btn btn-green" onclick="saveCell('M')" style="padding: 18px; font-size: 18px; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 5px;">
          <span>M</span>
          <span style="font-size: 10px; font-weight: 500; opacity: 0.8;">Mandatory</span>
        </button>
        <button class="btn" style="background:#FEF3C7; color:#92400E; padding: 18px; font-size: 18px; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 5px;" onclick="saveCell('S')">
          <span>S</span>
          <span style="font-size: 10px; font-weight: 500; opacity: 0.8;">On Request</span>
        </button>
        <button class="btn btn-white" onclick="saveCell('')" style="padding: 18px; font-size: 14px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 5px;">
          <i class="fa-solid fa-ban" style="font-size: 20px; color: #EF4444;"></i>
          <span>Revoke</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIG ---
    const API = 'https://script.google.com/macros/s/AKfycbxKobGBTRVtB8ED4UNzEsEmbZPXlvcpFwvpSdmEPcQkS_IuLRSZs5h42HwOAe_RDxh-MQ/exec';

    let STATE = { 
      user: null, 
      data: null, 
      filtered: null,
      matPage: 1,
      matPageSize: 20,
      appPage: 1,
      appPageSize: 20
    };
    
    let CHART_S = null;
    let CHART_Y = null;
    let ACTIVE_EDIT = null;

    // --- AUTH ---
    function init() {
      const u = localStorage.getItem('bravo_u');
      if(u) {
        STATE.user = JSON.parse(u);
        showApp();
      }
    }
    
    async function login() {
      const u = document.getElementById('u-in').value;
      const p = document.getElementById('p-in').value;
      document.querySelector('.btn-login').innerText = 'Checking...';
      
      const res = await api('login', { username: u, password: p });
      if(res.success) {
        STATE.user = res.user;
        localStorage.setItem('bravo_u', JSON.stringify(res.user));
        showApp();
      } else {
        document.getElementById('l-msg').innerText = res.error;
        document.querySelector('.btn-login').innerText = 'Secure Login';
      }
    }

    function logout() {
      localStorage.removeItem('bravo_u');
      window.location.href = window.location.href;
    }

    function showApp() {
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('app-sb').style.display = 'flex';
      document.getElementById('app-main').style.display = 'flex';
      document.getElementById('sb-user').innerText = STATE.user.username;
      document.getElementById('sb-role').innerText = STATE.user.role;
      loadData();
    }

    // --- DATA ---
    async function loadData() {
      document.getElementById('loader').style.display = 'block';
      const res = await api('get_full_data', { user: STATE.user });
      document.getElementById('loader').style.display = 'none';
      
      if(res.success) {
        STATE.data = res;
        STATE.filtered = res.matrix;
        STATE.matPage = 1;
        STATE.appPage = 1;
        renderDash();
        renderMat();
        renderApp();
      }
    }

    // --- DASHBOARD ---
    function renderDash() {
      const s = STATE.data.stats;
      document.getElementById('st-total').innerText = s.total;
      document.getElementById('st-active').innerText = s.active;
      document.getElementById('st-pending').innerText = s.pending;
      document.getElementById('st-reject').innerText = s.rejected;

      const ctxS = document.getElementById('chart-status');
      const ctxY = document.getElementById('chart-sys');

      if(CHART_S) CHART_S.destroy();
      if(CHART_Y) CHART_Y.destroy();

      CHART_S = new Chart(ctxS, {
        type: 'doughnut',
        data: {
          labels: ['Active', 'Pending', 'Rejected'],
          datasets: [{ data: [s.active, s.pending, s.rejected], backgroundColor: ['#2E7D32', '#F59E0B', '#EF4444'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, title: { display: true, text: 'Request Status Distribution' } } }
      });

      const sysLabels = Object.keys(s.bySys);
      const sysData = Object.values(s.bySys);

      CHART_Y = new Chart(ctxY, {
        type: 'bar',
        data: {
          labels: sysLabels,
          datasets: [{ label: 'Active Access Count', data: sysData, backgroundColor: '#4CAF50' }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Access per System' } } }
      });
    }

    // --- MATRIX WITH PAGINATION ---
    function filterMat() {
      const fd = document.getElementById('f-dept').value.toLowerCase();
      const fr = document.getElementById('f-role').value.toLowerCase();
      const fs = document.getElementById('f-sys').value.toLowerCase();

      STATE.filtered = STATE.data.matrix.filter(r => 
        r.dept.toLowerCase().includes(fd) &&
        r.role.toLowerCase().includes(fr) &&
        r.sys.toLowerCase().includes(fs)
      );
      STATE.matPage = 1;
      renderMat();
    }

    let matView = 'grid';
    function setMatView(v) {
      matView = v;
      document.querySelectorAll('.vt-btn').forEach(b => b.classList.remove('active'));
      event.currentTarget.classList.add('active');
      renderMat();
    }

    function renderMat() {
      const cont = document.getElementById('mat-container');
      const data = STATE.filtered;
      const sysList = STATE.data.systems;
      
      // Pagination
      const pageSize = STATE.matPageSize;
      const totalItems = data.length;
      const totalPages = Math.ceil(totalItems / pageSize);
      const start = (STATE.matPage - 1) * pageSize;
      const end = Math.min(start + pageSize, totalItems);
      const pageData = data.slice(start, end);
      
      // Update pagination info
      document.getElementById('mat-page-info').innerText = `Showing ${start + 1}-${end} of ${totalItems}`;
      document.getElementById('mat-prev').disabled = STATE.matPage === 1;
      document.getElementById('mat-next').disabled = STATE.matPage >= totalPages;

      if(matView === 'list') {
        let h = `<table><thead><tr><th>Dept</th><th>Role</th><th>System</th><th>Access</th><th>Status</th></tr></thead><tbody>`;
        pageData.forEach(r => {
           h += `<tr><td>${r.dept}</td><td>${r.role}</td><td>${r.sys}</td>
           <td><span class="cell-val cv-${r.acc}">${r.acc}</span></td><td>${r.status}</td></tr>`;
        });
        cont.innerHTML = h + `</tbody></table>`;
      } else {
        // Matrix Grid View
        const map = {};
        pageData.forEach(r => {
          const k = `${r.dept}|${r.sect}|${r.role}`;
          if(!map[k]) map[k] = {};
          map[k][r.sys] = r;
        });

        let h = `<table><thead><tr>
          <th class="matrix-col-sticky dept-col" style="width:1px">Dept</th>
          <th class="matrix-col-sticky role-col" style="width:1px">Role</th>`;
        
        sysList.forEach(s => h += `<th class="sys-header">${s}</th>`);
        h += `</tr></thead><tbody>`;

        Object.keys(map).sort().forEach(k => {
          const [d, sc, rl] = k.split('|');
          h += `<tr>
            <td class="matrix-col-sticky dept-col" style="text-align:left; font-weight:600; font-size:11px">${d}</td>
            <td class="matrix-col-sticky role-col" style="text-align:left">
              <div style="font-size:12px; font-weight:600">${rl}</div><div style="font-size:9px; color:#999">${sc}</div>
            </td>`;
          sysList.forEach(sys => {
            const cell = map[k][sys];
            const val = cell ? cell.acc : '';
            const cls = val ? `cv-${val}` : 'matrix-cell-empty';
            const displayVal = val || '—';
            const click = (STATE.user.role === 'IT_Admin') ? `onclick="editCell('${d}','${sc}','${rl}','${sys}')"` : '';
            const editCls = (STATE.user.role === 'IT_Admin') ? 'editable' : '';
            
            h += `<td class="${editCls}" ${click}><span class="cell-val ${cls}">${displayVal}</span></td>`;
          });
          h += `</tr>`;
        });
        cont.innerHTML = h + `</tbody></table>`;
        
        // Sticky position hesabla
        setTimeout(() => {
          const deptCols = document.querySelectorAll('.dept-col');
          if (deptCols.length > 1) {
            const deptWidth = deptCols[1].offsetWidth;
            document.querySelectorAll('.role-col').forEach(el => {
              el.style.left = deptWidth + 'px';
            });
          }
        }, 10);
      }
    }
    
    function matPrevPage() {
      if (STATE.matPage > 1) {
        STATE.matPage--;
        renderMat();
      }
    }
    
    function matNextPage() {
      const totalPages = Math.ceil(STATE.filtered.length / STATE.matPageSize);
      if (STATE.matPage < totalPages) {
        STATE.matPage++;
        renderMat();
      }
    }
    
    function changeMatPageSize() {
      STATE.matPageSize = parseInt(document.getElementById('mat-page-size').value);
      STATE.matPage = 1;
      renderMat();
    }

    // --- APPROVALS WITH PAGINATION ---
    function renderApp() {
      const list = STATE.data.approvals;
      const tbody = document.getElementById('app-body');
      
      const cnt = list.length;
      const badge = document.getElementById('badge-cnt');
      badge.innerText = cnt;
      badge.style.display = cnt > 0 ? 'inline-block' : 'none';
      
      // Pagination
      const pageSize = STATE.appPageSize;
      const totalPages = Math.ceil(cnt / pageSize);
      const start = (STATE.appPage - 1) * pageSize;
      const end = Math.min(start + pageSize, cnt);
      const pageData = list.slice(start, end);
      
      // Update pagination info
      if (cnt === 0) {
        document.getElementById('app-page-info').innerText = 'No pending requests';
        document.getElementById('app-prev').disabled = true;
        document.getElementById('app-next').disabled = true;
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:#999">No pending requests</td></tr>`;
        return;
      }
      
      document.getElementById('app-page-info').innerText = `Showing ${start + 1}-${end} of ${cnt}`;
      document.getElementById('app-prev').disabled = STATE.appPage === 1;
      document.getElementById('app-next').disabled = STATE.appPage >= totalPages;

      let h = '';
      pageData.forEach(r => {
        h += `<tr>
          <td><input type="checkbox" class="chk" value="${r.id}" onchange="chkUpdate()"></td>
          <td>${r.id}</td><td>${r.dept}</td><td>${r.role}</td><td>${r.sys}</td>
          <td><span class="cell-val cv-${r.acc}">${r.acc}</span></td>
          <td>${r.status}</td>
        </tr>`;
      });
      tbody.innerHTML = h;
    }
    
    function appPrevPage() {
      if (STATE.appPage > 1) {
        STATE.appPage--;
        renderApp();
      }
    }
    
    function appNextPage() {
      const totalPages = Math.ceil(STATE.data.approvals.length / STATE.appPageSize);
      if (STATE.appPage < totalPages) {
        STATE.appPage++;
        renderApp();
      }
    }
    
    function changeAppPageSize() {
      STATE.appPageSize = parseInt(document.getElementById('app-page-size').value);
      STATE.appPage = 1;
      renderApp();
    }

    function chkUpdate() {
      const n = document.querySelectorAll('.chk:checked').length;
      const btn = document.getElementById('btn-bulk');
      btn.innerText = `Take Action (${n})`;
      btn.disabled = n === 0;
    }

    function toggleAll(el) {
      document.querySelectorAll('.chk').forEach(c => c.checked = el.checked);
      chkUpdate();
    }

    // --- ACTIONS ---
    function openBulk() {
      document.getElementById('m-bulk').style.display = 'flex';
      document.getElementById('bulk-comment').value = '';
    }

    async function submitBulk(decision) {
      const ids = Array.from(document.querySelectorAll('.chk:checked')).map(c => c.value);
      const comment = document.getElementById('bulk-comment').value;
      
      if(decision === 'Rejected' && !comment) return alert('Comment is required for rejection');

      closeM('m-bulk');
      document.getElementById('loader').style.display = 'block';
      
      const res = await api('bulk_process', { ids, decision, comment, user: STATE.user });
      if(res.success) {
        alert(`${res.count} requests processed.`);
        loadData();
      }
    }

    function editCell(d, sc, r, s) {
      ACTIVE_EDIT = { dept: d, sect: sc, role: r, sys: s };
      document.getElementById('e-info').innerText = `${r} @ ${s}`;
      document.getElementById('m-edit').style.display = 'flex';
    }

    async function saveCell(val) {
      closeM('m-edit');
      document.getElementById('loader').style.display = 'block';
      const res = await api('save_change', { ...ACTIVE_EDIT, val, user: STATE.user });
      if(res.success) loadData();
    }

    // --- UTILS ---
    function api(act, data) {
      return new Promise(resolve => {
        const cb = 'cb'+Date.now();
        window[cb] = (res) => { delete window[cb]; document.body.removeChild(sc); resolve(res); };
        const sc = document.createElement('script');
        sc.src = `${API}?action=${act}&data=${encodeURIComponent(JSON.stringify(data))}&callback=${cb}`;
        document.body.appendChild(sc);
      });
    }

    function nav(p) {
      document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
      document.getElementById('v-'+p).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
      event.currentTarget.classList.add('active');
      document.getElementById('pg-title').innerText = p.charAt(0).toUpperCase() + p.slice(1);
    }
    
    function closeM(id) { document.getElementById(id).style.display = 'none'; }
    
    // ESC düyməsi ilə modal bağla
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
          if (modal.style.display === 'flex') {
            modal.style.display = 'none';
          }
        });
      }
    });
    
    init();
  </script>
</body>
</html>
