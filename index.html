<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bravo PAM | Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --bravo-green: #2E7D32; 
      --bravo-acc: #4CAF50;
      --bg-body: #F3F4F6;
      --bg-panel: #FFFFFF;
      --text: #111827;
      --border: #E5E7EB;
      --sidebar-w: 260px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

    /* LOGIN */
    #login-overlay { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-card { width: 400px; padding: 40px; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: white; }
    .btn-login { width: 100%; background: var(--bravo-green); color: white; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }

    /* LAYOUT */
    .sidebar { width: var(--sidebar-w); background: #111827; color: white; display: flex; flex-direction: column; }
    .sb-head { height: 64px; display: flex; align-items: center; padding: 0 24px; font-size: 18px; font-weight: 700; color: var(--bravo-acc); border-bottom: 1px solid #1F2937; }
    .sb-menu { padding: 20px 10px; flex: 1; }
    .nav-item { padding: 12px 16px; color: #9CA3AF; cursor: pointer; margin-bottom: 4px; border-radius: 8px; font-size: 14px; font-weight: 500; display: flex; gap: 12px; align-items: center; }
    .nav-item:hover { background: #1F2937; color: white; }
    .nav-item.active { background: var(--bravo-green); color: white; }
    
    .main { flex: 1; display: flex; flex-direction: column; }
    .topbar { height: 64px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 32px; }
    .content { flex: 1; padding: 24px; overflow: auto; }
    
    .view-section { display: none; }
    .view-section.active { display: block; }

    /* DASHBOARD */
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .stat-val { font-size: 24px; font-weight: 700; margin-top: 5px; }
    .chart-row { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: 300px; margin-bottom: 24px; }
    .chart-box { background: white; padding: 20px; border: 1px solid var(--border); border-radius: 8px; position: relative; }

    /* FILTER PANEL */
    .filter-bar { background: white; padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .f-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; min-width: 150px; }
    .view-toggles { display: flex; background: #F3F4F6; padding: 4px; border-radius: 6px; margin-left: auto; }
    .vt-btn { padding: 6px 12px; border: none; background: none; cursor: pointer; font-size: 12px; border-radius: 4px; font-weight: 600; color: #666; }
    .vt-btn.active { background: white; color: black; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    /* TABLES & MATRIX */
    .data-box { background: white; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .tbl-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 10px 15px; background: #F9FAFB; border-bottom: 1px solid var(--border); color: #666; font-size: 11px; text-transform: uppercase; white-space: nowrap; }
    td { padding: 10px 15px; border-bottom: 1px solid var(--border); white-space: nowrap; }
    
    /* Matrix Specific */
    .matrix-th-sticky { position: sticky; top: 0; z-index: 10; background: #F9FAFB; }
    .matrix-col-sticky { position: sticky; left: 0; z-index: 20; background: white; border-right: 2px solid #E5E7EB; }
    .cell-val { font-family: 'JetBrains Mono'; font-weight: 700; padding: 4px 8px; border-radius: 4px; }
    .cv-M { background: #DCFCE7; color: #166534; }
    .cv-S { background: #FEF3C7; color: #92400E; }
    .editable td:hover { background: #F3F4F6; cursor: pointer; }

    /* APPROVALS */
    .action-bar { padding: 12px 20px; background: #F9FAFB; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; }
    
    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal { background: white; width: 500px; border-radius: 12px; padding: 24px; box-shadow: 0 20px 25px rgba(0,0,0,0.1); }
    
    .btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; border: none; font-size: 13px; transition: 0.2s; }
    .btn-green { background: var(--bravo-green); color: white; }
    .btn-red { background: #EF4444; color: white; }
    .btn-white { background: white; border: 1px solid var(--border); }
    
    .loader { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 3000; background: rgba(76,175,80,0.2); display: none; }
    .bar { width: 0%; height: 100%; background: var(--bravo-acc); animation: load 1.5s infinite; }
    @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }
  </style>
</head>
<body>

  <div class="loader" id="loader"><div class="bar"></div></div>

  <!-- LOGIN -->
  <div id="login-overlay">
    <div class="login-card">
      <div style="font-size:24px; font-weight:800; color:var(--bravo-green); margin-bottom:20px;">
        <i class="fa-solid fa-shield-halved"></i> BRAVO PAM
      </div>
      <label style="font-size:12px; font-weight:600; color:#666">Username</label>
      <input id="u-in" class="f-input" style="width:100%; margin-bottom:15px; padding:12px;">
      <label style="font-size:12px; font-weight:600; color:#666">Password</label>
      <input id="p-in" type="password" class="f-input" style="width:100%; margin-bottom:20px; padding:12px;">
      <button class="btn-login" onclick="login()">Secure Login</button>
      <div id="l-msg" style="color:red; font-size:12px; margin-top:10px; text-align:center"></div>
    </div>
  </div>

  <!-- APP STRUCTURE -->
  <div class="sidebar" id="app-sb" style="display:none">
    <div class="sb-head"><i class="fa-solid fa-shield-halved" style="margin-right:10px"></i> BRAVO</div>
    <div class="sb-menu">
      <div class="nav-item active" onclick="nav('dash')"><i class="fa-solid fa-chart-pie"></i> Dashboard</div>
      <div class="nav-item" onclick="nav('matrix')"><i class="fa-solid fa-table-cells"></i> Access Matrix</div>
      <div class="nav-item" onclick="nav('approvals')">
        <i class="fa-solid fa-check-double"></i> Approvals
        <span class="badge" style="background:#F59E0B; color:white; margin-left:auto; display:none" id="badge-cnt">0</span>
      </div>
    </div>
    <div style="padding:20px; border-top:1px solid #1F2937">
      <div style="font-size:13px; font-weight:600" id="sb-user">-</div>
      <div style="font-size:11px; color:#9CA3AF" id="sb-role">-</div>
    </div>
  </div>

  <div class="main" id="app-main" style="display:none">
    <div class="topbar">
      <div style="font-weight:600; font-size:18px" id="pg-title">Dashboard</div>
      <button class="btn btn-white" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>

    <div class="content">
      
      <!-- DASHBOARD -->
      <div id="v-dash" class="view-section active">
        <div class="stats-row">
          <div class="stat-card">
            <div style="font-size:12px; color:#666">Total Records</div>
            <div class="stat-val" id="st-total">0</div>
          </div>
          <div class="stat-card">
            <div style="font-size:12px; color:#666">Active Access</div>
            <div class="stat-val" style="color:var(--bravo-green)" id="st-active">0</div>
          </div>
          <div class="stat-card">
            <div style="font-size:12px; color:#666">Pending Approval</div>
            <div class="stat-val" style="color:#F59E0B" id="st-pending">0</div>
          </div>
          <div class="stat-card">
            <div style="font-size:12px; color:#666">Rejected</div>
            <div class="stat-val" style="color:#EF4444" id="st-reject">0</div>
          </div>
        </div>

        <div class="chart-row">
          <div class="chart-box">
            <canvas id="chart-status"></canvas>
          </div>
          <div class="chart-box">
             <canvas id="chart-sys"></canvas>
          </div>
        </div>
      </div>

      <!-- MATRIX -->
      <div id="v-matrix" class="view-section">
        <div class="filter-bar">
          <i class="fa-solid fa-filter" style="color:#666"></i>
          <input id="f-dept" class="f-input" placeholder="Filter Dept..." onkeyup="filterMat()">
          <input id="f-role" class="f-input" placeholder="Filter Role..." onkeyup="filterMat()">
          <input id="f-sys" class="f-input" placeholder="Filter System..." onkeyup="filterMat()">
          <div class="view-toggles">
            <button class="vt-btn active" onclick="setMatView('grid')"><i class="fa-solid fa-table"></i></button>
            <button class="vt-btn" onclick="setMatView('list')"><i class="fa-solid fa-list"></i></button>
          </div>
        </div>

        <div class="data-box">
          <div class="tbl-wrap" id="mat-container"></div>
        </div>
      </div>

      <!-- APPROVALS -->
      <div id="v-approvals" class="view-section">
        <div class="data-box">
          <div class="action-bar">
            <div style="font-weight:600">Pending My Action</div>
            <button class="btn btn-green" id="btn-bulk" onclick="openBulk()" disabled>Take Action (0)</button>
          </div>
          <div class="tbl-wrap">
            <table id="app-tbl">
              <thead><tr><th style="width:30px"><input type="checkbox" onchange="toggleAll(this)"></th><th>ID</th><th>Dept</th><th>Role</th><th>System</th><th>Access</th><th>Status</th></tr></thead>
              <tbody id="app-body"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- BULK MODAL -->
  <div class="modal-overlay" id="m-bulk">
    <div class="modal">
      <h3 style="margin-bottom:15px">Process Request</h3>
      <p style="font-size:13px; color:#666; margin-bottom:20px">Please select an action for the selected requests.</p>
      
      <label style="font-size:12px; font-weight:600">Comment (Required for Rejection)</label>
      <textarea id="bulk-comment" class="f-input" style="width:100%; height:80px; margin-bottom:20px;"></textarea>
      
      <div style="display:flex; gap:10px; justify-content:flex-end">
        <button class="btn btn-white" onclick="closeM('m-bulk')">Cancel</button>
        <button class="btn btn-red" onclick="submitBulk('Rejected')">Reject</button>
        <button class="btn btn-green" onclick="submitBulk('Approved')">Approve</button>
      </div>
    </div>
  </div>

  <!-- CELL EDIT MODAL -->
  <div class="modal-overlay" id="m-edit">
    <div class="modal">
      <h3 style="margin-bottom:10px">Modify Access</h3>
      <div id="e-info" style="font-size:12px; color:#666; margin-bottom:20px; font-weight:600"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px">
        <button class="btn btn-green" onclick="saveCell('M')">M</button>
        <button class="btn" style="background:#FEF3C7; color:#92400E" onclick="saveCell('S')">S</button>
        <button class="btn btn-white" onclick="saveCell('')">Revoke</button>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIG ---
    const API = 'https://script.google.com/macros/s/AKfycbxKobGBTRVtB8ED4UNzEsEmbZPXlvcpFwvpSdmEPcQkS_IuLRSZs5h42HwOAe_RDxh-MQ/exec';

    let STATE = { user: null, data: null, filtered: null };
    let CHART_S = null;
    let CHART_Y = null;
    let ACTIVE_EDIT = null;

    // --- AUTH ---
    function init() {
      const u = localStorage.getItem('bravo_u');
      if(u) {
        STATE.user = JSON.parse(u);
        showApp();
      }
    }
    
    async function login() {
      const u = document.getElementById('u-in').value;
      const p = document.getElementById('p-in').value;
      document.querySelector('.btn-login').innerText = 'Checking...';
      
      const res = await api('login', { username: u, password: p });
      if(res.success) {
        STATE.user = res.user;
        localStorage.setItem('bravo_u', JSON.stringify(res.user));
        showApp();
      } else {
        document.getElementById('l-msg').innerText = res.error;
        document.querySelector('.btn-login').innerText = 'Secure Login';
      }
    }

    function logout() {
      localStorage.removeItem('bravo_u');
      window.location.href = window.location.href; // Force Reload
    }

    function showApp() {
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('app-sb').style.display = 'flex';
      document.getElementById('app-main').style.display = 'flex';
      document.getElementById('sb-user').innerText = STATE.user.username;
      document.getElementById('sb-role').innerText = STATE.user.role;
      loadData();
    }

    // --- DATA ---
    async function loadData() {
      document.getElementById('loader').style.display = 'block';
      const res = await api('get_full_data', { user: STATE.user });
      document.getElementById('loader').style.display = 'none';
      
      if(res.success) {
        STATE.data = res;
        STATE.filtered = res.matrix; // Init filtered with all allowed data
        renderDash();
        renderMat();
        renderApp();
      }
    }

    // --- DASHBOARD ---
    function renderDash() {
      const s = STATE.data.stats;
      document.getElementById('st-total').innerText = s.total;
      document.getElementById('st-active').innerText = s.active;
      document.getElementById('st-pending').innerText = s.pending;
      document.getElementById('st-reject').innerText = s.rejected;

      // CHARTS
      const ctxS = document.getElementById('chart-status');
      const ctxY = document.getElementById('chart-sys');

      if(CHART_S) CHART_S.destroy();
      if(CHART_Y) CHART_Y.destroy();

      CHART_S = new Chart(ctxS, {
        type: 'doughnut',
        data: {
          labels: ['Active', 'Pending', 'Rejected'],
          datasets: [{ data: [s.active, s.pending, s.rejected], backgroundColor: ['#2E7D32', '#F59E0B', '#EF4444'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, title: { display: true, text: 'Request Status Distribution' } } }
      });

      const sysLabels = Object.keys(s.bySys);
      const sysData = Object.values(s.bySys);

      CHART_Y = new Chart(ctxY, {
        type: 'bar',
        data: {
          labels: sysLabels,
          datasets: [{ label: 'Active Access Count', data: sysData, backgroundColor: '#4CAF50' }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Access per System' } } }
      });
    }

    // --- MATRIX ---
    function filterMat() {
      const fd = document.getElementById('f-dept').value.toLowerCase();
      const fr = document.getElementById('f-role').value.toLowerCase();
      const fs = document.getElementById('f-sys').value.toLowerCase();

      STATE.filtered = STATE.data.matrix.filter(r => 
        r.dept.toLowerCase().includes(fd) &&
        r.role.toLowerCase().includes(fr) &&
        r.sys.toLowerCase().includes(fs)
      );
      renderMat();
    }

    let matView = 'grid';
    function setMatView(v) {
      matView = v;
      document.querySelectorAll('.vt-btn').forEach(b => b.classList.remove('active'));
      event.currentTarget.classList.add('active');
      renderMat();
    }

    function renderMat() {
      const cont = document.getElementById('mat-container');
      const data = STATE.filtered;
      const sysList = STATE.data.systems;

      if(matView === 'list') {
        // Simple Table View
        let h = `<table><thead><tr><th>Dept</th><th>Role</th><th>System</th><th>Access</th><th>Status</th></tr></thead><tbody>`;
        data.forEach(r => {
           h += `<tr><td>${r.dept}</td><td>${r.role}</td><td>${r.sys}</td>
           <td><span class="cell-val cv-${r.acc}">${r.acc}</span></td><td>${r.status}</td></tr>`;
        });
        cont.innerHTML = h + `</tbody></table>`;
      } else {
        // Matrix Grid View
        const map = {};
        data.forEach(r => {
          const k = `${r.dept}|${r.sect}|${r.role}`;
          if(!map[k]) map[k] = {};
          map[k][r.sys] = r;
        });

        let h = `<table><thead><tr>
          <th class="matrix-col-sticky" style="min-width:120px">Dept</th>
          <th class="matrix-col-sticky" style="min-width:200px; left:120px">Role</th>`;
        sysList.forEach(s => h += `<th>${s}</th>`);
        h += `</tr></thead><tbody>`;

        Object.keys(map).sort().forEach(k => {
          const [d, sc, rl] = k.split('|');
          h += `<tr>
            <td class="matrix-col-sticky" style="text-align:left; font-weight:600">${d}</td>
            <td class="matrix-col-sticky" style="left:120px; text-align:left">
              <div>${rl}</div><div style="font-size:10px; color:#999">${sc}</div>
            </td>`;
          sysList.forEach(sys => {
            const cell = map[k][sys];
            const val = cell ? cell.acc : '';
            const cls = val ? `cv-${val}` : '';
            const click = (STATE.user.role === 'IT_Admin') ? `onclick="editCell('${d}','${sc}','${rl}','${sys}')"` : '';
            const editCls = (STATE.user.role === 'IT_Admin') ? 'editable' : '';
            
            h += `<td class="${editCls}" ${click}><span class="cell-val ${cls}">${val}</span></td>`;
          });
          h += `</tr>`;
        });
        cont.innerHTML = h + `</tbody></table>`;
      }
    }

    // --- APPROVALS ---
    function renderApp() {
      const list = STATE.data.approvals;
      const tbody = document.getElementById('app-body');
      
      // Update badge
      const cnt = list.length;
      const badge = document.getElementById('badge-cnt');
      badge.innerText = cnt;
      badge.style.display = cnt > 0 ? 'inline-block' : 'none';

      if(cnt === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:#999">No pending requests</td></tr>`;
        return;
      }

      let h = '';
      list.forEach(r => {
        h += `<tr>
          <td><input type="checkbox" class="chk" value="${r.id}" onchange="chkUpdate()"></td>
          <td>${r.id}</td><td>${r.dept}</td><td>${r.role}</td><td>${r.sys}</td>
          <td><span class="cell-val cv-${r.acc}">${r.acc}</span></td>
          <td>${r.status}</td>
        </tr>`;
      });
      tbody.innerHTML = h;
    }

    function chkUpdate() {
      const n = document.querySelectorAll('.chk:checked').length;
      const btn = document.getElementById('btn-bulk');
      btn.innerText = `Take Action (${n})`;
      btn.disabled = n === 0;
    }

    function toggleAll(el) {
      document.querySelectorAll('.chk').forEach(c => c.checked = el.checked);
      chkUpdate();
    }

    // --- ACTIONS ---
    function openBulk() {
      document.getElementById('m-bulk').style.display = 'flex';
      document.getElementById('bulk-comment').value = '';
    }

    async function submitBulk(decision) {
      const ids = Array.from(document.querySelectorAll('.chk:checked')).map(c => c.value);
      const comment = document.getElementById('bulk-comment').value;
      
      if(decision === 'Rejected' && !comment) return alert('Comment is required for rejection');

      closeM('m-bulk');
      document.getElementById('loader').style.display = 'block';
      
      const res = await api('bulk_process', { ids, decision, comment, user: STATE.user });
      if(res.success) {
        alert(`${res.count} requests processed.`);
        loadData();
      }
    }

    function editCell(d, sc, r, s) {
      ACTIVE_EDIT = { dept: d, sect: sc, role: r, sys: s };
      document.getElementById('e-info').innerText = `${r} @ ${s}`;
      document.getElementById('m-edit').style.display = 'flex';
    }

    async function saveCell(val) {
      closeM('m-edit');
      document.getElementById('loader').style.display = 'block';
      const res = await api('save_change', { ...ACTIVE_EDIT, val, user: STATE.user });
      if(res.success) loadData();
    }

    // --- UTILS ---
    function api(act, data) {
      return new Promise(resolve => {
        const cb = 'cb'+Date.now();
        window[cb] = (res) => { delete window[cb]; document.body.removeChild(sc); resolve(res); };
        const sc = document.createElement('script');
        sc.src = `${API}?action=${act}&data=${encodeURIComponent(JSON.stringify(data))}&callback=${cb}`;
        document.body.appendChild(sc);
      });
    }

    function nav(p) {
      document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
      document.getElementById('v-'+p).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
      event.currentTarget.classList.add('active');
      document.getElementById('pg-title').innerText = p.charAt(0).toUpperCase() + p.slice(1);
    }
    
    function closeM(id) { document.getElementById(id).style.display = 'none'; }
    
    init();
  </script>
</body>
</html>
